version: 0.2
phases:
  install:
  runtime-versions:
        docker: 20     
    commands: 
      - nohup /usr/local/bin/dockerd --host=unix:///var/run/docker.sock --host=tcp://127.0.0.1:2375 --storage-driver=overlay2&
      - timeout 15 sh -c "until docker info; do echo .; sleep 1; done"
      - pip3 install -r requirements-dev.txt
      - pip3 install -r app/requirements-links.txt
      - pip3 install -r app/requirements-app.txt
      - pip3 install -r app/tests/requirements-tests.txt
      - echo done with the install phase...
  pre_build:
    commands:      
      - echo Nothing to do in the pre_build phase...
  build:
    commands:
      - echo Build started on `date`
      - mkdir target
      - date > target/date.out
  post_build:
    commands:
      - pytest --rootdir=./app/tests/unit --override-ini junit_family=xunit1 --junit-xml=./results/UnitTest/junit.xml --cov ./app/tests/unit --cov-report=xml:results/CodeCoverage/cobertura-coverage.xml --cov-branch ./app/tests/unit --cov-config=setup.cfg
      - coverage2clover -i results/CodeCoverage/cobertura-coverage.xml -o results/CodeCoverage/clover.xml
      - coveragepy-lcov --data_file_path ./.coverage --output_file_path results/CodeCoverage/lcov.info
      - echo Building docker image now
      - cd .devcontainer/
      - docker build .
      - echo Build completed on `date`
artifacts:
  files:
    - target/date.out
    - build/*
    - ./results/*
    - .app/tests/*
